# 输出稳定性与规范化规范（v1）

本文档定义“同一组输入 -> 同一份输出”的稳定性要求，以及订阅节点的去重/命名/排序规则。

目标：让生成结果可 diff、可回滚、可定位问题；避免因为上游顺序抖动导致输出大面积噪音。

---

## 1. 名词与约束

### 1.1 命名空间

在 Surge/Shadowrocket 等目标中，**节点名**与**策略组名**通常共享同一命名空间（规则/组引用都用字符串）。

因此 v1 约束：
- 策略组名必须全局唯一（组与组之间）。
- 策略组名不得与任何节点名冲突；若冲突必须报错（profile 可改，订阅不可控，避免静默重写引发引用错误）。

### 1.2 保留名

以下字符串作为内置 action 保留（大小写敏感，v1 以大写为准）：
- `DIRECT`
- `REJECT`

约束：
- profile 中的策略组名不得为保留名；否则报错。
- 节点名若为保留名，允许编译器进行确定性重命名（见 3.2），以保证输出可用。

---

## 2. 订阅合并顺序（稳定输入序）

当请求包含多个订阅 URL：
- 合并顺序：按请求参数顺序合并（GET 的 `sub=` 出现顺序；POST 的 `subs[]` 数组顺序）。
- 每个订阅内部：按文本行顺序解析得到 Proxy 列表。

该“合并顺序”是后续去重与命名冲突处理的稳定基准。

---

## 3. 节点规范化（Normalization）

### 3.1 字段规范化

对每个 Proxy，v1 至少应做以下规范化（不改变语义）：
- `Name`：去首尾空白；不得包含 `\r`、`\n`、`\0`（否则报错或在更早阶段已报错）。
- `Server`：去首尾空白；域名应转小写（IP 原样）。
- `Cipher`：去首尾空白并转小写（方法名大小写不应影响语义）。
- `Password`：去首尾空白（是否允许空密码由订阅解析规范决定；v1 推荐不允许）。
- `Plugin`/`PluginOpts`：去首尾空白（不做重排；避免引入未知语义）。

### 3.2 节点命名生成与冲突处理

对每个 Proxy 先得到一个“基础名” `baseName`：
- 若订阅提供 `#name`：URL 解码后得到的名称，去首尾空白，作为 `baseName`。
- 否则：使用 `"<server>:<port>"` 作为 `baseName`。
基础名必须做最小兼容性规范化：
- 将所有 `=` 字符替换为 `-`（避免 Surge 系列配置解析失败；该处理必须是确定性的）。

然后按“合并顺序”依次为每个节点分配最终 `Name`，保证全局唯一：
- 若 `baseName` 未被占用且不是保留名：使用 `baseName`。
- 若 `baseName` 已被占用，或 `baseName` 是保留名：追加后缀 `-2`、`-3`…（从 2 开始递增），直到找到未占用的名字。

该规则必须只依赖“合并顺序”，保证可复现。

---

## 4. 去重（Deduplication）

v1 需要去重以避免重复节点污染策略组与 UI。去重必须确定且可复现。

### 4.1 去重 key（SS）

对 SS 节点定义去重 key（字符串或结构体均可），建议包含：
- `Type`（固定为 `ss`）
- `Server`（规范化后的）
- `Port`
- `Cipher`（规范化后的）
- `Password`（规范化后的）
- `Plugin`（规范化后的；空则空）
- `PluginOpts`（规范化后的；空则空）

### 4.2 去重策略

- 保留第一次出现的节点（按“合并顺序”）。
- 后续重复 key 的节点直接丢弃。

注意：
- 去重发生在“最终命名分配”之前（否则会把重复节点也算进占用名集合，导致后缀飘移）。

---

## 5. 输出顺序（Ordering）

### 5.1 节点输出顺序

为抵抗上游订阅随机排序，v1 推荐在输出时对节点按最终 `Name` 做升序排序：
- 比较规则：按 Unicode 码点顺序（实现上通常是字符串字节序）。
- 节点名已经唯一，因此不需要二级排序键。

若未来需要“保留订阅顺序”，应通过新增显式参数/配置实现；v1 固定为“按名字排序”以获得更稳定输出。

### 5.2 策略组输出顺序

- 策略组定义顺序必须与 profile 的 `custom_proxy_group` 列表顺序一致（不排序）。
- 策略组成员顺序：
  - `select`：按 profile 中 `[]成员` 的出现顺序输出；若出现 `@all`，则在该位置展开为“全部节点（按 5.1 的排序顺序）”。
  - `url-test`：成员来自正则筛选，输出顺序为“按节点名排序”（与 5.1 一致）。

### 5.3 规则输出顺序

最终规则列表顺序必须严格为：
1) 按 profile 的 `ruleset` 列表顺序逐个插入（不同 target 的呈现不同，但顺序必须一致）：
   - Clash：展开 ruleset 文件内容（每个 ruleset 内部保持文件行顺序）
   - Surge/Shadowrocket/Quantumult X：输出 ruleset 的“远程引用行”（不展开到配置文件）
2) 再按 profile 的 `rule` 列表顺序追加 inline 规则。

规则不做任何排序或去重（除非未来新增明确开关），以保证“用户写的顺序就是最终顺序”。

---

## 6. `mode=list` 输出稳定性

当 `mode=list` 输出纯节点列表时：
- 节点列表顺序：按 5.1 规则排序（最终 Name 升序）。
- raw（明文）输出：每行输出一条 canonical 的 `ss://` URI；使用 `\n` 分行，并且 **末尾必须带一个 `\n`**（便于 base64 输出稳定）。
- 当 `encode=base64`：对“raw 列表文本（UTF-8 字节序列）”做 **标准 base64** 编码输出；不得换行折行。

### 6.1 canonical `ss://` 行（v1）

v1 统一输出为 SIP002 常见形态（userinfo-base64）：

```
ss://<B64URL(method:password)>@<host>:<port>[/?plugin=<PCT_ENCODED(plugin)>][#<PCT_ENCODED(name)>]
```

规则：
- `<B64URL(method:password)>`：
  - 明文为 `cipher:password`（均使用规范化后的字段；cipher 小写）。
  - 使用 **URL-safe base64** 编码（RFC 4648 “base64url”字母表），并且 **去掉 padding `=`**。
- `<host>`/`<port>`：使用规范化后的 `server` 与 `port`；IPv6 必须写为 `[ipv6]`。
- `plugin`：
  - 若该节点存在 plugin（订阅 query 参数 `plugin`），必须输出 `/?plugin=...`。
  - `plugin` 值使用 UTF-8 百分号编码（RFC 3986），空格必须编码为 `%20`（不得用 `+`）。
  - v1 不对 plugin 内容做重排/规范化；按解析阶段得到的值原样输出（仅去首尾空白）。
- `name`：
  - 使用最终节点名（经过去重/命名冲突处理后的 `Name`）。
  - 使用 UTF-8 百分号编码（同上）。
  - 若 name 为空，可省略 `#...`。

---

## 7. Surge `#!MANAGED-CONFIG` 的 URL 稳定性

当 `mode=config&target=surge` 时需要生成 `<CURRENT_CONVERT_URL>`。

为保证稳定，v1 要求：
- **统一生成**：无论请求是 GET 还是 POST，`<CURRENT_CONVERT_URL>` 都必须由服务端根据“解析后的参数”重新序列化生成，不得直接复用原始 query 字符串（避免参数顺序/编码差异导致输出不稳定）。

- base URL 选择：
  1) 若 profile 提供 `public_base_url`（见《Profile YAML 规范》），必须使用它作为 base URL（推荐它已包含 `/sub` 路径）。
  2) 否则使用当前请求推导出的 base URL（scheme/host/path）。若服务部署在反代后，推导规则属于实现细节，但必须保证对外可访问。

- query 参数序列化顺序（固定）：
  1) `mode=config`
  2) `target=surge`
  3) `fileName=<name>`（可选）
  4) 按请求中订阅数组顺序重复输出 `sub=<url>`（GET 的 `sub=` 出现顺序；POST 的 `subs[]` 数组顺序）
  5) `profile=<url>`

（该顺序只影响字符串稳定性，不影响语义。）
