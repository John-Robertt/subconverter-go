# SS 订阅解析规范（v1）

本文档定义“SS 订阅”的输入格式、自动识别规则、URI 支持范围与校验规则。

本项目没有“宽松修复”模式：任何订阅解析错误都必须导致 HTTP 返回错误，错误中应包含 URL/行号/片段。

---

## 1. 范围（Scope）

v1 仅支持：
- 订阅内容由 **ss:// URI** 组成（每行一个）。
- 订阅整体可以是“明文列表”或“base64 编码后的明文列表”。

v1 不支持（遇到即报错）：
- 非 `ss://` 的协议行（例如 `ssr://`、`vmess://`、`trojan://`、`hysteria://` 等）。
- 订阅内容中的“非注释非空行”不是合法 URI。

---

## 2. 订阅文本的编码与自动识别

### 2.1 基本输入约定

订阅拉取后得到一段字节序列：
- 必须是 UTF-8 文本；若存在 UTF-8 BOM（`0xEF 0xBB 0xBF`）应忽略 BOM。
- 去除首尾空白（空格/Tab/CR/LF）后不得为空；否则报错。

### 2.2 两种支持的订阅编码

1) **明文列表（raw）**
- 内容按行分割（支持 LF 或 CRLF）。
- 每个非空、非注释行是一条 `ss://` URI。

2) **base64 列表（b64）**
- 内容是对“明文列表整体文本（包含换行）”做 base64 编码后的结果。
- 允许包含空白字符（空格/Tab/CR/LF）；解码前应移除所有空白字符。
- 允许缺失 padding（`=`）；解码器应能处理。
- 允许标准 base64 与 URL-safe base64 两种字母表。

### 2.3 自动识别算法（必须确定且可复现）

给定去 BOM、去首尾空白后的文本 `S`：

1) 若 `S` 中包含子串 `ss://`，则视为 **raw**，按第 3 节逐行解析。
2) 否则视为 **b64**：
   - 移除 `S` 内所有空白字符得到 `S2`。
   - 尝试用 base64（标准或 URL-safe，允许无 padding）解码 `S2`。
   - 解码成功后得到 `T`（UTF-8 文本），按第 3 节逐行解析 `T`。
   - 解码失败则报错（错误码建议：`SUB_BASE64_DECODE_ERROR`）。

说明：
- v1 不提供“强制指定编码”的请求参数；编码由上述算法唯一决定。
- 订阅拉取的超时/大小上限/重定向等约束见《远程拉取（Fetch）规范》。

---

## 3. 明文列表逐行解析规则

### 3.1 行分割与注释

对 raw 文本按 `\n` 分割为多行，并对每行执行：
- 去除行首尾空白。
- 空行：忽略。
- 注释行：若去空白后以 `#` 开头，则忽略。
- 其它行：必须是合法的 `ss://` URI；否则报错，并提供行号与原始片段（snippet）。

### 3.2 允许的 URI 形态（v1）

v1 支持两类常见 SS URI（兼容大部分订阅提供方）：

#### 形态 A：userinfo-base64（SIP002 常见）

```
ss://<B64(method:password)>@<host>:<port>[/?plugin=...][#<name>]
```

其中：
- `<B64(method:password)>`：base64（标准或 URL-safe，允许无 padding）。解码后必须形如 `method:password`。
- `<host>`：域名、IPv4、或带 `[]` 的 IPv6。
- `<port>`：十进制整数 1..65535。
- `plugin`：可选（见 3.3）。
- `name`：可选；从 fragment（`#...`）获取并进行 URL 解码。

#### 形态 B：全量 base64（旧格式仍常见）

```
ss://<B64(method:password@host:port)>[#<name>]
```

其中 `<B64(...)>` 解码后必须包含 `@` 与 `:port`，并满足：
- 使用 **最后一个 `@`** 分割出左侧凭据与右侧 `host:port`（避免密码中出现 `@` 时直接崩溃）。
- 凭据部分按“第一个 `:`”切分 `method` 与 `password`（密码允许包含 `:`）。

解码后得到的 `host/port` 与 `name` 解析规则与形态 A 相同。

### 3.3 `plugin` 参数（可选）

v1 仅支持识别 query 参数 `plugin`：

```
?plugin=<plugin-name>[;<k>=<v>...]
```

处理要求：
- 若出现 `plugin`，必须把 `<plugin-name>` 与其余 `;<k>=<v>` 作为结构化字段保存到 Proxy（具体字段名由实现决定）。
- 若出现未知 query 参数（非 `plugin`），v1 必须报错（避免“看似成功但语义不明”）。

说明：
- “能解析”不等于“能输出到所有 target”。若某 target renderer 不支持该 plugin，编译/渲染阶段应报错（不是在订阅解析阶段悄悄丢弃）。

---

## 4. 字段校验（必须报错的情况）

解析为 Proxy 时至少必须校验：
- URI scheme 不是 `ss`（或不是 `ss://` 开头）
- base64 解码失败
- 解码后缺少 `method` 或 `password`
- `host` 为空
- `port` 非法或不在 1..65535
- `name`（若存在）包含换行/控制字符（至少禁止 `\r`、`\n`、`\0`；避免配置注入）
- 出现未知 query 参数

---

## 5. 多订阅合并与错误定位要求

请求允许多个订阅 URL（例如 GET 多个 `sub=` 或 POST `subs[]`）：
- 合并顺序：按请求参数给出的顺序合并，每个订阅内部按行顺序。
- 去重/重命名/排序不属于本规范（见《输出稳定性与规范化规范》）。

错误定位要求：
- 报错必须包含：`stage=parse_sub`、订阅 URL、行号（1-based）、snippet（该行原文，建议截断）。
