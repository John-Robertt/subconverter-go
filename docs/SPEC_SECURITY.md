# 安全与内网访问规范（v1）

本文档描述 v1 的安全边界与默认运行姿势。它不是“把风险抹平”，而是把风险**说清楚**并给出最小可行的防踩雷约束。

v1 的关键前提：**允许访问内网 URL**（订阅/profile/template/ruleset 都可能在内网）。

---

## 1. 威胁模型（你必须接受的事实）

本服务对外暴露一个“可控 URL 拉取 + 解析 + 拼装输出”的能力。

当允许内网 URL 时，如果该服务对不可信网络开放，它天然具备：
- **SSRF**：攻击者可借你服务去探测/访问内网资源。
- **带宽/资源消耗**：可被利用拉取大文件、慢连接，拖垮服务。

v1 的策略是不做“万能安全网”，而是：
- 在协议与资源层做硬约束（超时、大小上限、协议限制、重定向限制）。
- 给出默认运行姿势，避免用户“无意中把 SSRF 服务开到公网”。

---

## 2. 远程内容：只解析、不执行

v1 对远程输入的强约束：
- profile/template/ruleset/subscription 一律按**纯文本数据**处理。
- 不支持任何可执行模板语言，不执行 JS/Lua/脚本。
- 输出内容完全由“编译器渲染器 + 模板锚点注入”产生（见 `SPEC_TEMPLATE_ANCHORS.md`），不存在“远程内容可被执行”的路径。

---

## 3. URL 访问策略（v1 必须满足）

硬约束（v1 强制）：
- 仅允许 `http://` 与 `https://`（其余 scheme 直接报错，见 `SPEC_FETCH.md`）。
- 必须有超时、响应体大小上限、重定向次数上限（见 `SPEC_FETCH.md`）。

关于“内网/外网”：
- v1 不禁止私网/内网 IP，也不做 DNS 解析后的网段拦截（因为用户明确需要访问内网）。
- 这意味着 **SSRF 风险由部署姿势承担**（见第 4 节）。

---

## 4. 默认运行姿势（强烈建议）

为了让“默认行为”更安全，建议 v1 的默认配置为：
- 默认仅监听 `127.0.0.1`（需要显式配置才允许 `0.0.0.0` / 公网监听）。
- 若对外暴露（反代或直连），必须增加简单鉴权（例如 token），否则此服务可被滥用为内网探测器。

说明：
- 鉴权方案属于实现与部署策略，不强行写死到 v1 的 HTTP API 规范里；但服务端实现应当留出钩子（例如中间件/handler 前置检查）。

---

## 5. `public_base_url`：避免“对外 URL 指向内网”

当输出 `target=surge` 且 `mode=config` 时，需要生成 `#!MANAGED-CONFIG <CURRENT_CONVERT_URL> ...`。

如果服务跑在内网或反代后：
- 直接从当前请求推导出来的 base URL 可能是内网地址（例如 `http://127.0.0.1:25500/sub`），对 Surge 客户端不可达。

因此 v1 允许在 profile 提供 `public_base_url`（见 `SPEC_PROFILE_YAML.md`）：
- 一旦提供，必须用它生成 `<CURRENT_CONVERT_URL>`（见 `SPEC_DETERMINISM.md` 的序列化规则）。
- 该字段本质上是“对外可达的订阅转换入口”，不应包含敏感 query（也不得包含 query/fragment）。

