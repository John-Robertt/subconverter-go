<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light" />
    <title>subconverter-go</title>
    <style>
      :root{
        /* Required palette */
        --primary-100:#FF4081;
        --primary-200:#ff79b0;
        --primary-300:#ffe4ff;
        --accent-100:#00E5FF;
        --accent-200:#00829b;
        --text-100:#333333;
        --text-200:#5c5c5c;
        --bg-100:#F5F5F5;
        --bg-200:#ebebeb;
        --bg-300:#c2c2c2;

        /* Style tokens */
        --radius-lg: 22px;
        --radius-md: 16px;
        --shadow-1: 0 12px 40px rgba(0,0,0,.08);
        --shadow-2: 0 18px 60px rgba(0,0,0,.12);
        --glass: rgba(255,255,255,.58);
        --glass-2: rgba(255,255,255,.40);
        --glass-border: rgba(255,255,255,.45);
      }

      *{ box-sizing:border-box; }
      html,body{ height:100%; }
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC",
          "Noto Sans CJK SC", "Source Han Sans SC", "Microsoft YaHei", sans-serif;
        color: var(--text-100);
        background: radial-gradient(1200px 800px at 18% 10%, rgba(255,64,129,.18), transparent 55%),
          radial-gradient(1200px 800px at 82% 20%, rgba(0,229,255,.14), transparent 50%),
          linear-gradient(180deg, var(--bg-100), var(--bg-200));
      }

      .wrap{
        max-width: 1120px;
        margin: 0 auto;
        padding: 26px 18px 40px;
      }

      header{
        display:flex;
        align-items:flex-end;
        justify-content:space-between;
        gap: 18px;
        margin-bottom: 18px;
      }

      .brand{
        display:flex;
        flex-direction:column;
        gap: 8px;
      }
      .brand h1{
        margin:0;
        font-size: 34px;
        font-weight: 760;
        letter-spacing: .2px;
        line-height: 1.1;
      }
      .brand p{
        margin:0;
        color: var(--text-200);
        font-size: 14px;
        line-height: 1.55;
      }

      .badge{
        display:inline-flex;
        align-items:center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 999px;
        background: var(--glass);
        border: 1px solid var(--glass-border);
        box-shadow: var(--shadow-1);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        color: var(--text-200);
        font-size: 13px;
        white-space: nowrap;
      }
      .dot{
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--accent-100);
        box-shadow: 0 0 0 6px rgba(0,229,255,.14);
        animation: pulse 2.8s ease-in-out infinite;
      }

      @keyframes pulse{
        0%,100%{ transform: scale(1); opacity: .9; }
        50%{ transform: scale(1.06); opacity: 1; }
      }

      .grid{
        display:grid;
        grid-template-columns: 1.25fr .9fr;
        gap: 16px;
      }
      @media (max-width: 960px){
        .grid{ grid-template-columns: 1fr; }
        header{ flex-direction: column; align-items:flex-start; }
      }

      .card{
        border-radius: var(--radius-lg);
        background: var(--glass);
        border: 1px solid var(--glass-border);
        box-shadow: var(--shadow-1);
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        overflow:hidden;
        position: relative;
      }
      .card::before{
        content:"";
        position:absolute;
        inset:-1px;
        background: radial-gradient(600px 220px at 20% 0%, rgba(255,255,255,.55), transparent 60%),
          radial-gradient(600px 220px at 80% 0%, rgba(255,255,255,.45), transparent 60%);
        pointer-events:none;
      }

      .card .inner{
        position: relative;
        padding: 18px 18px 16px;
      }

      .card h2{
        margin:0 0 10px;
        font-size: 16px;
        font-weight: 720;
      }

      .tabs{
        display:flex;
        gap: 10px;
        margin-bottom: 14px;
      }
      .tab{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        padding: 10px 12px;
        border-radius: 999px;
        cursor:pointer;
        user-select:none;
        border: 1px solid rgba(255,255,255,.55);
        background: rgba(255,255,255,.38);
        color: var(--text-200);
        font-weight: 650;
        font-size: 13px;
        transition: transform .16s ease, box-shadow .16s ease, background .16s ease, color .16s ease;
      }
      .tab:hover{ transform: translateY(-1px); box-shadow: 0 10px 26px rgba(0,0,0,.08); }
      .tab[aria-selected="true"]{
        background: linear-gradient(180deg, rgba(255,64,129,.26), rgba(0,229,255,.18));
        color: var(--text-100);
        border-color: rgba(255,255,255,.68);
      }

      .form{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      @media (max-width: 720px){
        .form{ grid-template-columns: 1fr; }
      }

      label{
        display:flex;
        flex-direction:column;
        gap: 8px;
        font-size: 12px;
        color: var(--text-200);
      }

      input, select, textarea{
        font: inherit;
        border: 0;
        outline: none;
        padding: 12px 12px;
        border-radius: var(--radius-md);
        background: rgba(255,255,255,.62);
        box-shadow: inset 0 1px 0 rgba(255,255,255,.9), 0 10px 30px rgba(0,0,0,.06);
        color: var(--text-100);
        transition: transform .16s ease, box-shadow .16s ease, background .16s ease;
      }
      textarea{
        min-height: 140px;
        resize: vertical;
        line-height: 1.55;
      }
      input:focus, select:focus, textarea:focus{
        background: rgba(255,255,255,.78);
        box-shadow: inset 0 1px 0 rgba(255,255,255,.9), 0 0 0 4px rgba(255,64,129,.16), 0 18px 40px rgba(0,0,0,.09);
      }

      .full{ grid-column: 1 / -1; }

      .hint{
        font-size: 12px;
        color: var(--text-200);
        line-height: 1.55;
        margin-top: 8px;
      }

      .actions{
        display:flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
        align-items:center;
      }
      .btn{
        border: 0;
        cursor:pointer;
        padding: 11px 14px;
        border-radius: 999px;
        font-weight: 720;
        font-size: 13px;
        letter-spacing: .1px;
        transition: transform .16s ease, box-shadow .16s ease, filter .16s ease, opacity .16s ease;
        user-select:none;
      }
      .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-2); }
      .btn:active{ transform: translateY(0); filter: saturate(1.06); }

      .btn-primary{
        color: #fff;
        background: linear-gradient(135deg, var(--primary-100), var(--accent-100));
        box-shadow: 0 16px 46px rgba(255,64,129,.24);
        animation: breathe 3.4s ease-in-out infinite;
      }
      @keyframes breathe{
        0%,100%{ box-shadow: 0 16px 46px rgba(255,64,129,.20); }
        50%{ box-shadow: 0 18px 56px rgba(255,64,129,.30); }
      }
      .btn-ghost{
        color: var(--text-100);
        background: rgba(255,255,255,.46);
        border: 1px solid rgba(255,255,255,.65);
      }
      .btn-link{
        color: var(--accent-200);
        background: transparent;
        padding: 8px 8px;
        font-weight: 680;
      }
      .btn[disabled]{
        opacity: .55;
        cursor:not-allowed;
        transform:none;
        box-shadow:none;
        animation:none;
      }
      [aria-disabled="true"]{
        pointer-events: none;
        opacity: .55;
      }

      .out{
        display:flex;
        flex-direction:column;
        gap: 10px;
      }
      .mono{
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }
      .urlbox{
        display:flex;
        gap: 10px;
        align-items:center;
      }
      .urlbox input{
        flex: 1;
        min-width: 0;
      }

      .preview{
        padding: 14px;
        border-radius: var(--radius-lg);
        background: rgba(255,255,255,.46);
        border: 1px solid rgba(255,255,255,.62);
        box-shadow: inset 0 1px 0 rgba(255,255,255,.9), 0 10px 30px rgba(0,0,0,.06);
      }

      pre{
        margin: 0;
        font-size: 12px;
        line-height: 1.55;
        color: var(--text-100);
        white-space: pre-wrap;
        word-break: break-word;
      }

      .status{
        display:flex;
        gap: 10px;
        align-items:center;
        color: var(--text-200);
        font-size: 12px;
      }
      .status strong{ color: var(--text-100); font-weight: 760; }
      .chip{
        padding: 5px 10px;
        border-radius: 999px;
        background: rgba(0,0,0,.05);
        border: 1px solid rgba(255,255,255,.65);
      }

      .err{
        border-left: 4px solid var(--primary-100);
        padding-left: 10px;
      }
      footer{
        margin-top: 14px;
        color: var(--text-200);
        font-size: 12px;
      }
      footer a{ color: var(--accent-200); text-decoration: none; }
      footer a:hover{ text-decoration: underline; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="brand">
          <h1>subconverter-go</h1>
          <p>输入 SS 订阅 + profile（远程模板/规则/策略组），输出 Clash/Surge/Shadowrocket/QuanX 配置或纯节点列表。</p>
        </div>
        <div class="badge" title="服务状态（由 /healthz 检测）">
          <span class="dot" aria-hidden="true"></span>
          <span id="healthText">检测中...</span>
        </div>
      </header>

      <div class="grid">
        <section class="card" aria-label="生成链接">
          <div class="inner">
            <h2>生成订阅转换链接</h2>

            <div class="tabs" role="tablist" aria-label="模式">
              <div class="tab" id="tabConfig" role="tab" tabindex="0" aria-selected="true">配置文件（mode=config）</div>
              <div class="tab" id="tabList" role="tab" tabindex="-1" aria-selected="false">纯节点列表（mode=list）</div>
            </div>

            <div class="form" id="form">
              <label class="full">
                订阅 URL（每行一个，可多个）
                <textarea id="subs" placeholder="https://example.com/ss.txt&#10;https://example.com/ss2.txt"></textarea>
              </label>

              <label id="targetWrap">
                输出 target
                <select id="target">
                  <option value="clash">clash（mihomo）</option>
                  <option value="surge">surge</option>
                  <option value="shadowrocket">shadowrocket</option>
                  <option value="quanx">quanx（Quantumult X）</option>
                </select>
              </label>

              <label id="encodeWrap" hidden>
                输出 encode（仅 mode=list）
                <select id="encode">
                  <option value="base64">base64（默认）</option>
                  <option value="raw">raw（明文 ss:// 每行一个）</option>
                </select>
              </label>

              <label id="profileWrap" class="full">
                profile URL（远程 YAML）
                <input id="profile" type="url" placeholder="https://example.com/profile.yaml" />
              </label>

              <label class="full">
                fileName（可选，用于自定义下载文件名）
                <input id="fileName" type="text" placeholder="my_config（无需写扩展名）" />
              </label>
            </div>

            <div class="hint">
              提示：<span class="mono">ruleset</span> 在 v1 不由服务端展开；Clash 输出会生成 <span class="mono">rule-providers</span> + <span class="mono">RULE-SET</span> 引用。
            </div>

            <div class="actions">
              <button class="btn btn-primary" id="btnBuild">生成 URL</button>
              <button class="btn btn-ghost" id="btnCopy" disabled>复制</button>
              <a class="btn btn-ghost" id="btnOpen" href="#" target="_blank" rel="noopener" aria-disabled="true" style="text-decoration:none; display:inline-flex;">打开</a>
              <button class="btn btn-ghost" id="btnPreview" disabled>预览请求</button>
            </div>

            <div class="out" style="margin-top:14px;">
              <div class="urlbox">
                <input id="outURL" class="mono" readonly placeholder="生成后的 /sub?... URL 会出现在这里" />
              </div>
              <div class="preview" id="curlWrap" hidden>
                <pre class="mono" id="outCurl"></pre>
              </div>
            </div>
          </div>
        </section>

        <section class="card" aria-label="预览与错误">
          <div class="inner">
            <h2>预览 / 错误定位</h2>
            <div class="status">
              <span class="chip">HTTP</span>
              <span id="previewStatus">尚未请求</span>
            </div>
            <div style="height:10px;"></div>
            <div class="preview">
              <pre class="mono" id="previewBody">点击「预览请求」后，这里会显示返回内容（最多展示前 8000 字符）。</pre>
            </div>

            <footer>
              接口：<span class="mono">GET /sub</span>、<span class="mono">POST /api/convert</span>、<span class="mono">GET /healthz</span>
            </footer>
          </div>
        </section>
      </div>
    </div>

    <script>
      (function(){
        const $ = (id) => document.getElementById(id);

        const tabConfig = $("tabConfig");
        const tabList = $("tabList");

        const subsEl = $("subs");
        const targetWrap = $("targetWrap");
        const targetEl = $("target");
        const encodeWrap = $("encodeWrap");
        const encodeEl = $("encode");
        const profileWrap = $("profileWrap");
        const profileEl = $("profile");
        const fileNameEl = $("fileName");

        const btnBuild = $("btnBuild");
        const btnCopy = $("btnCopy");
        const btnOpen = $("btnOpen");
        const btnPreview = $("btnPreview");

        const outURL = $("outURL");
        const outCurl = $("outCurl");
        const curlWrap = $("curlWrap");

        const previewStatus = $("previewStatus");
        const previewBody = $("previewBody");

        let mode = "config";

        function setMode(next){
          mode = next;
          const isConfig = mode === "config";

          tabConfig.setAttribute("aria-selected", isConfig ? "true" : "false");
          tabConfig.tabIndex = isConfig ? 0 : -1;
          tabList.setAttribute("aria-selected", isConfig ? "false" : "true");
          tabList.tabIndex = isConfig ? -1 : 0;

          targetWrap.hidden = !isConfig;
          profileWrap.hidden = !isConfig;
          encodeWrap.hidden = isConfig;

          // Small UX: change placeholders.
          outURL.value = "";
          outCurl.textContent = "";
          curlWrap.hidden = true;
          btnCopy.disabled = true;
          btnPreview.disabled = true;
          btnOpen.href = "#";
          btnOpen.setAttribute("aria-disabled", "true");

          persist();
        }

        function parseSubs(){
          const lines = (subsEl.value || "").split("\n").map(s => s.trim()).filter(Boolean);
          // Keep order; drop obvious comments.
          return lines.filter(s => !s.startsWith("#"));
        }

        function buildURL(){
          const subs = parseSubs();
          if (subs.length === 0){
            throw new Error("请至少填写 1 个订阅 URL");
          }

          const u = new URL("/sub", window.location.href);
          u.searchParams.set("mode", mode);

          if (mode === "config"){
            const target = (targetEl.value || "").trim();
            const profile = (profileEl.value || "").trim();
            if (!target){
              throw new Error("target 不能为空");
            }
            if (!profile){
              throw new Error("profile 不能为空");
            }
            u.searchParams.set("target", target);
            u.searchParams.set("profile", profile);
          } else {
            const encode = (encodeEl.value || "").trim();
            if (encode){
              u.searchParams.set("encode", encode);
            }
          }

          const fileName = (fileNameEl.value || "").trim();
          if (fileName){
            u.searchParams.set("fileName", fileName);
          }

          for (const s of subs){
            u.searchParams.append("sub", s);
          }

          return u.toString();
        }

        function buildCurl(url){
          // Keep it copy-friendly.
          return "curl -G " + JSON.stringify(url.split("?")[0]) + " \\\n" +
            url.split("?")[1].split("&").map(kv => "  --data-urlencode " + JSON.stringify(decodeURIComponent(kv.replace(/\+/g, "%20")))).join(" \\\n");
        }

        async function copyText(s){
          if (navigator.clipboard && navigator.clipboard.writeText){
            await navigator.clipboard.writeText(s);
            return;
          }
          // Fallback
          outURL.focus();
          outURL.select();
          document.execCommand("copy");
        }

        async function preview(url){
          previewStatus.textContent = "请求中...";
          previewBody.textContent = "";
          try{
            const res = await fetch(url, { method: "GET" });
            const text = await res.text();
            const status = res.status;

            if (status >= 200 && status < 300){
              previewStatus.innerHTML = "成功 <strong>" + status + "</strong>（显示前 8000 字符）";
              previewBody.textContent = (text.length > 8000) ? (text.slice(0, 8000) + "\n...\n") : text;
              return;
            }

            // Try parse JSON error.
            let pretty = text;
            try{
              const obj = JSON.parse(text);
              if (obj && obj.error){
                const e = obj.error;
                pretty =
                  "error.code: " + (e.code || "") + "\n" +
                  "error.message: " + (e.message || "") + "\n" +
                  "error.stage: " + (e.stage || "") + "\n" +
                  (e.url ? ("error.url: " + e.url + "\n") : "") +
                  (e.line ? ("error.line: " + e.line + "\n") : "") +
                  (e.snippet ? ("error.snippet: " + e.snippet + "\n") : "") +
                  (e.hint ? ("error.hint: " + e.hint + "\n") : "");
              }
            }catch(_){}

            previewStatus.innerHTML = "失败 <strong>" + status + "</strong>";
            previewBody.textContent = pretty;
          }catch(err){
            previewStatus.innerHTML = "失败 <strong>fetch error</strong>";
            previewBody.textContent = String(err && err.message ? err.message : err);
          }
        }

        function persist(){
          try{
            const data = {
              v: 1,
              mode,
              subs: subsEl.value,
              target: targetEl.value,
              encode: encodeEl.value,
              profile: profileEl.value,
              fileName: fileNameEl.value,
            };
            localStorage.setItem("scgo_ui_v1", JSON.stringify(data));
          }catch(_){}
        }

        function restore(){
          try{
            const raw = localStorage.getItem("scgo_ui_v1");
            if (!raw) return;
            const data = JSON.parse(raw);
            if (!data || data.v !== 1) return;
            subsEl.value = data.subs || "";
            targetEl.value = data.target || "clash";
            encodeEl.value = data.encode || "base64";
            profileEl.value = data.profile || "";
            fileNameEl.value = data.fileName || "";
            setMode(data.mode === "list" ? "list" : "config");
          }catch(_){}
        }

        tabConfig.addEventListener("click", () => setMode("config"));
        tabList.addEventListener("click", () => setMode("list"));
        tabConfig.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") setMode("config"); });
        tabList.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") setMode("list"); });

        for (const el of [subsEl, targetEl, encodeEl, profileEl, fileNameEl]){
          el.addEventListener("input", persist);
          el.addEventListener("change", persist);
        }

        btnBuild.addEventListener("click", (e) => {
          e.preventDefault();
          try{
            const url = buildURL();
            outURL.value = url;
            outCurl.textContent = buildCurl(url);
            curlWrap.hidden = false;
            btnCopy.disabled = false;
            btnPreview.disabled = false;
            btnOpen.href = url;
            btnOpen.setAttribute("aria-disabled", "false");
          }catch(err){
            previewStatus.innerHTML = "输入错误";
            previewBody.textContent = String(err && err.message ? err.message : err);
          }
        });

        btnCopy.addEventListener("click", async (e) => {
          e.preventDefault();
          if (!outURL.value) return;
          btnCopy.disabled = true;
          try{
            await copyText(outURL.value);
            btnCopy.textContent = "已复制";
            setTimeout(() => { btnCopy.textContent = "复制"; btnCopy.disabled = false; }, 900);
          }catch(_){
            btnCopy.disabled = false;
          }
        });

        btnPreview.addEventListener("click", async (e) => {
          e.preventDefault();
          if (!outURL.value) return;
          await preview(outURL.value);
        });

        async function health(){
          const el = document.getElementById("healthText");
          try{
            const u = new URL("/healthz", window.location.href);
            const res = await fetch(u.toString(), { method: "GET" });
            const ok = res.status >= 200 && res.status < 300;
            el.textContent = ok ? "服务就绪" : ("服务异常 " + res.status);
          }catch(_){
            el.textContent = "无法连接服务";
          }
        }

        restore();
        health();
      })();
    </script>
  </body>
</html>
